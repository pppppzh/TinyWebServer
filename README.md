# TinyWebServer

## 项目功能
利用I/O复用技术epoll与线程池实现多线程的Reactor高并发模型；
利用正则表达式与状态机解析HTTP请求报文，实现处理静态资源的请求，并发送响应报文；
利用标准库容器封装char，实现自动增长的缓冲区；
基于小根堆实现的定时器，关闭超时的非活动连接；
利用单例模式与阻塞队列实现异步的日志系统，记录服务器运行状态；
利用RAII机制实现了数据库连接池，减少数据库连接建立与关闭的开销

## 项目描述
该项目总体框架采用的是单Reactor多线程模型，在主线程里面通过I/O多路复用监听多个文件描述符上的事件。主线程负责连接的建立和断开、把读写和逻辑处理函数加入线程池的任务队列，由线程池的子线程完成相应的读写操作，实现任务的高并发处理。在最底层实现了自动增长的Buffer缓冲区。在应用层方面实现心跳机制，通过定时器清楚掉不活跃的连接以减少高并发场景下不必要的系统资源的占用（文件描述符的占用、维护TCP连接所需要的资源等）。对于HTTP请求报文，采用分散读进行读取，使用有限状态机和正则表达式进行解析；并通过集中写和内存映射的方式对响应报文进行传输。应用层还实现了数据库功能，采用RAII机制实现连接池，可以实现基本的注册和登录功能。最后还加入了日志模块帮助工程项目开发和实现服务器的日常运行情况的记录。

## 主要类描述
### 1.buffer类
由于使用非阻塞I/O模型，所以需要实现应用层buffer。即在应用程序发送数据时，并不需要关注生产的数据如何发送（一次性或分成多次发送），只需要调用send()函数，将数据交给buffer，等待socket变为可写时buffer将存储的数据进行发送。同理，在应用程序接受数据时，由于TCP协议是无边界的字节流协议，极大可能会出现数据流不完整情况，所以收到的数据要放到buffer中，等接受消息完整后，再通知应用程序进行读取。

buffer类的设计参考了muduo网络库，内部使用vector\<char>进行数据存储。为了防止迭代器失效的问题，buffer类中使用了两个int类型的成员变量作为index，即readIndex、writeIndex。两个index将vector分成三份：prependable、readable、writable。当向buffer写入数据，writeIndex向后移动；当从buffer取出数据，readIndex向后移动。经过多次读写后，readIndex可能移动到较后的位置，留下了较大的prependable空间，此时如果写入的数据大小大于writable空间并且小于writable+prependable的大小，buffer不会重新分配内存，而是把已有的数据移动到prependable。

在buffer::ReadFd()函数中，在栈上申请了一个stackbuff，利用readv()读取数据，将数据读入到buffer和stackbuf中。当读入的数据不多时，全部读入buffer中；如果长度超过buffer大小，就会读到stackbuff中。减少了系统调用的同时，降低了系统内存占用。


### 2.日志系统
由于日志记录数据涉及到文件I/O操作，当日志数据较大时，同步模式可能会阻塞程序的处理流程，导致并发性较低。所以需要使用异步模式的日志，将需要记录的日志数据先存入阻塞队列中，由其他线程从阻塞队列中取出内容，写入日志。blockqueue类使用deque实现，类内的成员函数实现参照了生产者消费者模型，通过搭配锁和条件变量保证了线程安全。

log类的设计模式为单例模式，保证只有一个log类的实例，并提供Instance()函数作为全局访问点。

### 3.线程池与连接池
线程池主要解决了两个问题：1.提高资源利用率，通过预先创建一组线程并对其进行复用，减少了线程频繁创建和销毁所造成的时间和资源损耗。2.提高线程可管理性，通过线程池对线程进行统一分配调控。可以管理线程并发数量，从而降低线程之间的竞争，增加性能。

连接池用于解决在高并发情况下，频繁向数据库申请、释放资源带来性能损耗的问题。为数据库的连接创建一个缓存池，提前放入一定量的连接，当多个任务需要访问数据库时，不需要再去通过TCP连接MySQL server，直接在缓存池中取对应数量的连接即可。用完之后也不需要释放连接，只需要还回缓存即可。

### 4.HTTP
对于HTTP连接，主要需要的功能为：读取请求、解析请求、生成响应、发送响应。其中，httpconn类负责读取和发送，httprequest类负责解析请求，httpresponse负责生成响应。
